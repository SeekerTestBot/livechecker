name: Update gists

on:
  workflow_dispatch:
    inputs:
      skip_core:
        default: false
      skip_cask:
        default: true
      skip_linux:
        default: false
      skip_bio:
        default: false

#   schedule:
#     # Every 6 hours except midnight
#     - cron: '0 6,12,18 * * *'

env:
  HOMEBREW_NO_COLOR: 1
  HOMEBREW_NO_ANALYTICS: 1
  HOMEBREW_NO_AUTO_UPDATE: 1
  HOMEBREW_NO_INSTALL_CLEANUP: 1

jobs:

  check-core:
    if: ${{ !github.event.inputs.skip_core }}
    runs-on: macos-latest
    steps:
      - run: brew update-reset
      - run: curl -o core.txt -L https://gist.github.com/SeekerTestBot/26cd541935bd0380a0ac0e996fc56195/raw
      - uses: actions/checkout@v2
      - run: brew ruby $GITHUB_WORKSPACE/print-updated.rb core.txt livecheck --debug > core.txt
      - uses: actions/upload-artifact@v2
        with:
          name: core
          path: core.txt

  check-cask:
    if: ${{ !github.event.inputs.skip_cask }}
    runs-on: macos-latest
    steps:
      - run: brew update-reset
      - run: brew tap SeekingMeaning/cask-livecheck
      - run: curl -o cask.txt -L https://gist.github.com/SeekerTestBot/94b2ada768a1b2c5839667414806d2b0/raw
      - uses: actions/checkout@v2
      - run: brew ruby $GITHUB_WORKSPACE/print-updated.rb cask.txt cask-livecheck --debug > cask.txt
      - uses: actions/upload-artifact@v2
        with:
          name: cask
          path: cask.txt

  check-linux:
    if: ${{ !github.event.inputs.skip_linux }}
    runs-on: ubuntu-latest
    container:
      image: homebrew/ubuntu16.04:master
    steps:
      - run: brew update-reset
      - run: curl -o linux.txt -L https://gist.github.com/SeekerTestBot/58843cb8fdd4b3a6ef841b066726209a/raw
      - uses: actions/checkout@v2
      - run: brew ruby $GITHUB_WORKSPACE/print-updated.rb linux.txt livecheck --debug > linux.txt
      - uses: actions/upload-artifact@v2
        with:
          name: linux
          path: linux.txt

  check-bio:
    if: ${{ !github.event.inputs.skip_bio }}
    runs-on: ubuntu-latest
    container:
      image: homebrew/ubuntu16.04:master
    steps:
      - run: brew update-reset
      - run: brew tap brewsci/bio
      - run: curl -o bio.txt -L https://gist.github.com/SeekerTestBot/d804d3e7a2895257d47c26abf9ae486a/raw
      - uses: actions/checkout@v2
      - run: brew ruby $GITHUB_WORKSPACE/print-updated.rb bio.txt livecheck --debug > bio.txt
      - uses: actions/upload-artifact@v2
        with:
          name: bio
          path: bio.txt

  gist-core:
    needs: check-core
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v2
        with:
          name: core
      - uses: popsiclestick/gist-sync-action@v1.0.0
        with:
          auth: ${{ secrets.GIST_TOKEN }}
          gist_url: https://gist.github.com/SeekerTestBot/26cd541935bd0380a0ac0e996fc56195
          gist_title: homebrew-core.txt
          github_file: core.txt

  gist-cask:
    needs: check-cask
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v2
        with:
          name: cask
      - uses: popsiclestick/gist-sync-action@v1.0.0
        with:
          auth: ${{ secrets.GIST_TOKEN }}
          gist_url: https://gist.github.com/SeekerTestBot/94b2ada768a1b2c5839667414806d2b0
          gist_title: homebrew-cask.txt
          github_file: cask.txt

  gist-linux:
    needs: check-linux
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v2
        with:
          name: linux
      - uses: popsiclestick/gist-sync-action@v1.0.0
        with:
          auth: ${{ secrets.GIST_TOKEN }}
          gist_url: https://gist.github.com/SeekerTestBot/58843cb8fdd4b3a6ef841b066726209a
          gist_title: linuxbrew-core.txt
          github_file: linux.txt

  gist-bio:
    needs: check-bio
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v2
        with:
          name: bio
      - uses: popsiclestick/gist-sync-action@v1.0.0
        with:
          auth: ${{ secrets.GIST_TOKEN }}
          gist_url: https://gist.github.com/SeekerTestBot/d804d3e7a2895257d47c26abf9ae486a
          gist_title: brewsci-bio.txt
          github_file: bio.txt
